services:
  couchdb:
    ports:
      - 127.0.0.1:5984:5984
  arsnova-proxy:
    ports:
      - 127.0.0.1:${PORT:-8080}:80
  arsnova-webclient:
    image: devcontainer-arsnova-webclient:$WEBCLIENT_TAG
    build:
      context: arsnova-webclient/.devcontainer
      args:
        APP_IMAGE: registry.gitlab.com/particify/dev/foss/arsnova-webclient:$WEBCLIENT_TAG
    command: /bin/sh -c "while sleep 1000; do :; done"
    volumes:
      - ./.git:/workspace/.git
      - ./arsnova-webclient:/workspace/arsnova-webclient
  arsnova-server-core:
    image: devcontainer-arsnova-server-core:$CORE_TAG
    build:
      context: arsnova-backend/.devcontainer
      args:
        APP_IMAGE: registry.gitlab.com/particify/dev/foss/arsnova-server/core:$CORE_TAG
        INSTALL_MAVEN: "true"
        MAVEN_VERSION: $MAVEN_VERSION
    environment:
      SERVER_PORT: ""
      SPRING_APPLICATION_JSON: '{"server": {"port": "8080"}}'
      SECURITY_CORSORIGINS_0: http://localhost
      SECURITY_CORSORIGINS_1: http://localhost:4200
    volumes:
      - ./.git:/workspace/.git
      - ./arsnova-backend:/workspace/arsnova-backend
      - maven-cache:/home/dev/.m2
  arsnova-server-gateway:
    image: devcontainer-arsnova-server-gateway:$GATEWAY_TAG
    build:
      context: arsnova-http-gateway/.devcontainer
      args:
        APP_IMAGE: registry.gitlab.com/particify/dev/foss/arsnova-server/gateway:$GATEWAY_TAG
        INSTALL_MAVEN: "true"
        MAVEN_VERSION: $MAVEN_VERSION
    environment:
      SERVER_PORT: ""
      SPRING_APPLICATION_JSON: '{"server": {"port": "8080"}}'
    volumes:
      - ./.git:/workspace/.git
      - ./arsnova-http-gateway:/workspace/arsnova-http-gateway
      - maven-cache:/home/dev/.m2
  arsnova-server-websocket:
    image: devcontainer-arsnova-server-websocket:$WEBSOCKET_TAG
    build:
      context: arsnova-ws-gateway/.devcontainer
      args:
        APP_IMAGE: registry.gitlab.com/particify/dev/foss/arsnova-server/websocket:$WEBSOCKET_TAG
        INSTALL_MAVEN: "true"
        MAVEN_VERSION: $MAVEN_VERSION
    environment:
      SERVER_PORT: ""
      SPRING_APPLICATION_JSON: '{"server": {"port": "8080"}}'
    volumes:
      - ./.git:/workspace/.git
      - ./arsnova-ws-gateway:/workspace/arsnova-ws-gateway
      - maven-cache:/home/dev/.m2
  arsnova-server-authz:
    image: devcontainer-arsnova-server-authz:$AUTHZ_TAG
    build:
      context: arsnova-auth-service/.devcontainer
      args:
        APP_IMAGE: registry.gitlab.com/particify/dev/foss/arsnova-server/authz:$AUTHZ_TAG
        INSTALL_MAVEN: "true"
        MAVEN_VERSION: $MAVEN_VERSION
    environment:
      SERVER_PORT: ""
      SPRING_APPLICATION_JSON: '{"server": {"port": "8080"}}'
      PGHOST: postgresql-authz
      PGDATABASE: arsnovaauth
      PGUSER: arsnovaauth
      PGPASSWORD: arsnovaauth
    volumes:
      - ./.git:/workspace/.git
      - ./arsnova-auth-service:/workspace/arsnova-auth-service
      - maven-cache:/home/dev/.m2
  arsnova-server-comments:
    image: devcontainer-arsnova-server-comments:$COMMENTS_TAG
    build:
      context: arsnova-comment-service/.devcontainer
      args:
        APP_IMAGE: registry.gitlab.com/particify/dev/foss/arsnova-server/comments:$COMMENTS_TAG
        INSTALL_MAVEN: "true"
        MAVEN_VERSION: $MAVEN_VERSION
    environment:
      SERVER_PORT: ""
      SPRING_APPLICATION_JSON: '{"server": {"port": "8080"}}'
      PGHOST: postgresql-comments
      PGDATABASE: arsnovacomment
      PGUSER: arsnovacomment
      PGPASSWORD: arsnovacomment
    volumes:
      - ./.git:/workspace/.git
      - ./arsnova-comment-service:/workspace/arsnova-comment-service
      - maven-cache:/home/dev/.m2
  arsnova-server-formatting:
    image: devcontainer-arsnova-server-formatting:$FORMATTING_TAG
    build:
      context: arsnova-formatting-service/.devcontainer
      args:
        APP_IMAGE: registry.gitlab.com/particify/dev/foss/arsnova-server/formatting:$FORMATTING_TAG
    environment:
      PORT: 3000
    volumes:
      - ./.git:/workspace/.git
      - ./arsnova-formatting-service:/workspace/arsnova-formatting-service

volumes:
  gradle-cache:
